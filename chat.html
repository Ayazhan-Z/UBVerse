<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>UB GlobalPal - Chat</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">

  <style>
    :root {
      --ub-blue: #005bbb;
      --ub-gray: #5e6a71;
      --bg-light: #f8f9fa;
    }
    * { box-sizing: border-box; }
    
    .app-container {
      max-width: 100%;
      height: calc(100vh - 64px);
      margin: 0 auto;
      background: #fff;
      display: flex;
      flex-direction: column;
    }

    .chat-header {
      background: var(--accent);
      color: #fff;
      padding: 15px 20px;
      display: flex;
      align-items: center;
      gap: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .chat-header-icon { font-size: 30px; }
    .chat-header-text h1 { margin: 0; font-size: 20px; font-weight: 600; }
    .chat-header-text p { margin: 2px 0 0; font-size: 12px; opacity: 0.85; }

    #chat-box {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      background-image: radial-gradient(#e1e5ea 1px, transparent 0);
      background-size: 20px 20px;
    }
    .message {
      max-width: 85%;
      margin-bottom: 15px;
      padding: 12px 16px;
      border-radius: 18px;
      line-height: 1.45;
      font-size: 15px;
      animation: fadeIn 0.3s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    .bot {
      background: #f1f3f5;
      color: #212529;
      align-self: flex-start;
      border-bottom-left-radius: 4px;
      margin-right: auto;
    }
    .user {
      background: var(--accent);
      color: #fff;
      align-self: flex-end;
      border-bottom-right-radius: 4px;
      margin-left: auto;
    }

    .quick-replies {
      padding: 10px 15px;
      display: flex;
      gap: 8px;
      overflow-x: auto;
      background: #fff;
      scrollbar-width: none;
    }
    .quick-replies::-webkit-scrollbar { display: none; }
    .chip {
      white-space: nowrap;
      background: #eef2f6;
      color: var(--accent);
      padding: 8px 14px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      border: 1px solid #dee2e6;
    }
    .chip:hover { background: var(--accent); color: #fff; border-color: var(--accent); }

    .input-zone {
      padding: 15px;
      background: #fff;
      border-top: 1px solid #eee;
      display: flex;
      gap: 10px;
    }
    #user-input {
      flex: 1;
      padding: 14px 18px;
      border: 2px solid #eee;
      border-radius: 30px;
      font-size: 16px;
      outline: none;
      transition: border-color 0.3s;
    }
    #user-input:focus { border-color: var(--accent); }
    #send-btn {
      background: var(--accent);
      color: #fff;
      border: none;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 20px;
      display: flex; align-items: center; justify-content: center;
      transition: transform 0.2s;
    }
    #send-btn:hover { transform: scale(1.05); }
    #send-btn:disabled { background: #ccc; transform: none; }

    .loading-dots::after {
      content: ' .';
      animation: dots 1.5s steps(5, end) infinite;
    }
    @keyframes dots {
      0%, 20% { content: ' .'; }
      40%     { content: ' ..'; }
      60%     { content: ' ...'; }
      80%,100%{ content: ' '; }
    }
  </style>
</head>
<body>
  <div class="topnav">
    <div class="topnav-content">
      <div class="nav-left">
        <img src="ub.jpg" alt="UB Logo" class="logo">
        <span class="logo-text">UBverse</span>
      </div>
      <div class="nav-right">
        <a href="index.html">Home</a>
        <a class="active" href="chat.html">Chat</a>
        <a href="translator.html">Translator</a>
        <a href="map.html">Map</a>
        <a href="region.html">Region Matcher</a>
        <a href="mood.html">Mood Tracker</a>
      </div>
    </div>
  </div>

  <div class="app-container">
    <div class="chat-header">
      <div class="chat-header-icon">üêÇ</div>
      <div class="chat-header-text">
        <h1>UB GlobalPal</h1>
        <p>Orientation ‚Ä¢ Dining ‚Ä¢ Support</p>
      </div>
    </div>

    <div id="chat-box">
      <div class="message bot">
        Hey there! I'm GlobalPal üêÇüíô.<br><br>
        I'm here to help you navigate life at UB. Need halal food spots? Feeling homesick? Confused about "The Stampede"? Just ask!
      </div>
    </div>

    <div class="quick-replies">
      <div class="chip" onclick="ask('Where can I get halal food?')">üåØ Halal Food</div>
      <div class="chip" onclick="ask('I feel really lonely today')">üòî Feeling Lonely</div>
      <div class="chip" onclick="ask('How much should I tip?')">üíµ Tipping Rules</div>
      <div class="chip" onclick="ask('What is Tim Hortons?')">‚òï Timmies?</div>
    </div>

    <form class="input-zone" id="chat-form">
      <input type="text" id="user-input" placeholder="Ask me anything..." autocomplete="off" />
      <button type="submit" id="send-btn">‚û§</button>
    </form>
  </div>

  <script>
    const chatBox   = document.getElementById('chat-box');
    const userInput = document.getElementById('user-input');
    const sendBtn   = document.getElementById('send-btn');
    let history = [];

    function appendMessage(text, sender, isLoading = false) {
      const div = document.createElement('div');
      div.className = `message ${sender} ${isLoading ? 'loading-dots' : ''}`;
      div.innerHTML = String(text).replace(/\n/g, '<br>');
      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
      return div;
    }

    async function ask(query) {
      if (!query || !query.trim()) return;

      appendMessage(query, 'user');
      userInput.value = '';
      sendBtn.disabled = true;
      const loadingMsg = appendMessage('Typing', 'bot', true);

      try {
        const res = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: query, history })
        });
        const data = await res.json();

        chatBox.removeChild(loadingMsg);
        appendMessage(data.reply || data.error || 'Sorry, something went wrong.', 'bot');

        if (data.reply) {
          history.push({ role: "user",  parts: [{ text: query }] });
          history.push({ role: "model", parts: [{ text: data.reply }] });
        }
      } catch (err) {
        chatBox.removeChild(loadingMsg);
        appendMessage("‚ö†Ô∏è Connect error! Is the chatbot configured?", 'bot');
      }
      sendBtn.disabled = false;
    }

    document.getElementById('chat-form').addEventListener('submit', (e) => {
      e.preventDefault();
      ask(userInput.value);
    });
  </script>
</body>
</html>
